{% extends 'base.html' %}

{% block title %} Analysis {% endblock %}

{% block body %}

<div class="container">

    <!-- START FILE INPUT CARD -->
    <div style="padding-top:10%" id="input_card" class="row align-items-center justify-content-center">
        <div class="card text-center">
            <div class="card-header bg-dark text-light">
                <strong>Load The Heart Disease Dataset</strong>
            </div>

            <div class="card-body text-light bg-secondary">
                <h5 class="card-title">Once Loaded The Data Will Be Displayed in Tabular View</h5>
                <p class="card-text">This input supports the heart disease dataset only</p>

                <div class="form-group ">
                    <div class="custom-file pmd-custom-file-outline">
                        <input type="file" class="custom-file-input" id="load_data" accept=".csv">
                        <label class="custom-file-label" for="load_data">Choose file</label>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- END FILE INPUT CARD -->

    <!-- START TABULAR VIEW -->
    <div id="tabular_view" class="table-responsive" style="margin-bottom: 2%; margin-top: 2%;">
        <table class="table table-light table-head-content-width" id="data_table"> </table>


    </div>
    <!-- END TABULAR VIEW -->

    <div id="next_button" class="d-flex flex-row-reverse">
        <button type="button" class="btn btn-primary" onclick="cleanData()">Clean Data</button>
    </div>
</div>

<script>

    $(document).ready(() => {
        $('#tabular_view').hide();
        $('#next_button').removeClass('d-flex');
        $('#next_button').css('display', 'none');
    });

    $("#load_data").on('change', function () {
        console.log($('#load_data').prop('files')[0])
        const csvFile = $('#load_data').prop('files')[0];
        const reader = new FileReader();

        reader.onload = (event) => {
            const text = event.target.result;
            const [headers, data] = ObjectifyCSV(text);

            // Hide the input card and show tablular_view on successful upload
            $('#input_card').hide();
            $('#next_button').addClass('d-flex');
            $('#tabular_view').show();

            fillDataInTable(headers, data);
        }

        reader.readAsText(csvFile);
    });


    function ObjectifyCSV(str, delimiter = ",") {
        // slice from start of text to the first \n index
        // use split to create an array from string by delimiter
        let headers = str.slice(0, str.indexOf("\n")).split(delimiter).map(
            (value) => { return value.replace("\r", ""); }
        );

        // slice from \n index + 1 to the end of the text
        // use split to create an array of each csv value row
        let rows = str.slice(str.indexOf("\n") + 1).split("\n").map(
            (value) => { return value.replace("\r", ""); }
        );

        // Map the rows
        // split values from each row into an array
        // use headers.reduce to create an object
        // object properties derived from headers:values
        // the object passed as an element of the array
        const arr = rows.map(function (row) {
            const values = row.split(delimiter);
            const el = headers.reduce(function (object, header, index) {
                object[header] = values[index];
                return object;
            }, {});
            return el;
        });

        localStorage.setItem('headers', headers);
        localStorage.setItem('objectified_data', JSON.stringify(arr));

        return [headers, arr]

    }

    function fillDataInTable(headers, data) {
        let [tableStructure, tableHead, tableData] = ['', '', ''];
        let table = $('#data_table');

        headers.forEach((header) => tableHead += `<th scope="col">${header}</th>`);
        data.forEach((row, index) => {
            let rowDetails = `<tr> <th scope="row">${index}</th>`;
            let rowValues = Object.values(row);
            rowValues.forEach((cellValue) => rowDetails += `<td> ${cellValue} </td>`);
            rowDetails += '</tr>';

            tableData += rowDetails;
        });

        tableStructure += `
            <thead class="thead-light">
                <tr> 
                    <th scope="col">#</th>
                    ${tableHead} 
                </tr>
            </thead>

            <tbody>
                ${tableData}
            </tbody>
        `
        table.append(tableStructure);
        table.DataTable();
    }

    function cleanData() {
        const data = localStorage.objectified_data;

        $.ajax({
            url: '/clean_data',
            type: 'POST',
            data: data,   // converts js value to JSON string
            contentType: 'application/json;charset=UTF-8',
        }).done(function (result) {     // on success get the return object from server
            console.log(result)     // do whatever with it. In this case see it in console
        })
    }
</script>

{% endblock %}